---
title: "error testing"
output: html_notebook
---



# Libraries
```{r}
#Libraries 
library(DSI)
library(DSOpal)
library(httr)
library(dsConnectClient)
library(dsBaseClient)
```

```{r}
devtools::session_info()
```


# Only one server

```{r}
server.names      <- c("Paris")
url_Paris         <- 'https://192.168.57.101:8443'
table_Paris       <- "TESTING.DATASET1"
user_Paris        <-  "administrator"
password_Paris    <-  "datashield_test&"
ssl_options_Paris <- "list(ssl_verifyhost=0,ssl_verifypeer=0)"
driver_Paris      <- "OpalDriver"

server.urls       <- c(url_Paris)
server.tables     <- c(table_Paris)
server.users.id   <- c(user_Paris)
server.users.pwd  <-  c(password_Paris)
server.ssl.options <- c(ssl_options_Paris)
server.drivers   <- c(driver_Paris)
```


```{r}
login.data <- ds.build.login.data.frame(server.names,
                                        server.urls,
                                        server.tables,
                                        server.users.id,
                                        server.users.pwd,
                                        server.ssl.options,
                                        server.drivers)
print(login.data)
```

# set the server variables and login
```{R}
server.var <- list('ID','CHARACTER', 'LOGICAL','NA_VALUES','INTEGER','NULL_VALUES',
                   'NON_NEGATIVE_INTEGER','POSITIVE_INTEGER','NEGATIVE_INTEGER',
                   'NUMERIC', 'NON_NEGATIVE_NUMERIC','POSITIVE_NUMERIC','NEGATIVE_NUMERIC',
                   'FACTOR_CHARACTER','FACTOR_INTEGER','IDENTIFIER','CATEGORY','IDENTIFIER',
                   'CATEGORY')
connections <- ds.login(login.data, variables = server.var, symbol = 'D')
print(connections)
```

#test_errors
```{r}
server.function.call <- call('dimDS','D')
print(server.function.call)
outcome <- ds.aggregate(expression = server.function.call, asynchronous = FALSE, datasources = connections)
print(outcome)
```


The code of the server-side function is:

test_errorDS <- function()
{
  if(getOption("TESTING") == 1)
  {
    stop("ERR::SERVER::TESTING::001")
  }
  
  if(getOption("TESTING") == 2)
  {
    stop("ERR::SERVER::TESTING::002")
  }
  
  if(getOption("TESTING") == 3)
  {
    stop("ERR::SERVER::TESTING::003")
  }
}


```{r}
server.function.call <- call('test_errorDS')
print(server.function.call)
outcome <- ds.aggregate(expression = server.function.call, asynchronous = FALSE, datasources = connections)
print(outcome)
```
The code for the server-side function is: 

test_mixed_errorDS <- function()
{
  if(getOption("TESTING") == 1)
  {
    stop(‘you are not allowed’)
  }
   
  return(3.14)
}


```{r}
server.function.call <- call('test_mixed_errorDS')
print(server.function.call)
outcome <- ds.aggregate(expression = server.function.call, asynchronous = FALSE, datasources = connections)
print(outcome)
```

#assign
#ds.assign.value
```{r}
ds.colnames("D",connections)
```

```{r}
ds.dataFrame(x = c("D$INTEGER"), newobj ="df", datasources = connections, notify.of.progress = TRUE)
```

```{r}
datashield.errors()
```

```{r}
datashield.errors()

```

```{r}
server.function.call <- call('lsDS', NULL,".GlobalEnv")
print(server.function.call)
outcome <- ds.aggregate(expression = server.function.call, asynchronous = FALSE, error.stop = TRUE, datasources = connections)
print(outcome)
```

```{r}
ds.asInteger(x.name = "df", newobj = "dfint", connections)
```



```{r}
datashield.errors()
```

verify the value set to the option datashield.errors.stop
```{r}
#options(datashield.errors.stop = TRUE)
print(getOption("datashield.errors.stop"))
```



```{r}
#lsDS<-function(search.filter=NULL,env.to.search)
server.function.call <- call('lsDS', NULL,".GlobalEnv")
print(server.function.call)
outcome <- ds.aggregate(expression = server.function.call, asynchronous = FALSE, error.stop = TRUE, datasources = connections)
print(outcome)
```

The code for the server-side function is :
assignPi <- function()
{
  return(pi)
}


```{r}
datashield.errors()
```
```{r}
options(datashield.errors.stop = FALSE)
outcome <- ds.assign.value(new.variable.name = "new_var",
                value = "D$INTEGER", 
                class.type = "integer", 
                datasources = connections)
datashield.errors()
print(outcome)
```
```{r}
#lsDS<-function(search.filter=NULL,env.to.search)
server.function.call <- call('lsDS', NULL,".GlobalEnv")
print(server.function.call)
outcome <- ds.aggregate(expression = server.function.call, asynchronous = FALSE, error.stop = TRUE, datasources = connections)
print(outcome)
```

```{r}
options(datashield.errors.stop = FALSE)
DSI::datashield.assign(conns = connections, symbol = "aPieInTheSky", value = as.symbol("D$INTEGER"), async = FALSE)
#print(DSI::datashield.errors())
```
```{r}
tryCatch(DSI::datashield.assign(conns = connections, symbol = "aPieInTheSky", value= as.symbol("D$INTEGER"), async = FALSE),error = function(error){print(DSI::datashield.errors())})
```


```{r}
#lsDS<-function(search.filter=NULL,env.to.search)
#server.function.call <- call('lsDS', NULL,".GlobalEnv")
#print(server.function.call)
#outcome <- ds.aggregate(expression = server.function.call, asynchronous = FALSE, error.stop = TRUE, datasources = connections)
#print(outcome)
```

```{r}
#assignPi <- function()
#server.function.call <- call('assignPi')
#DSI::datashield.assign(conns = connections, symbol = "aPieInTheSky", value = server.function.call, async = FALSE)
```

```{r}
#assignPi <- function()
#{
#  return(pi)
#}
#assignPi <- function()
#server.function.call <- call('assignPi')
#print(server.function.call)
#tryCatch(DSI::datashield.assign(conns = connections, symbol = "aPieInTheSky", value = server.function.call, async = FALSE),
#         error = function(error){print(DSI::datashield.errors())})
```

```{r}
#assignPi <- function()
#{
#  return(pi)
#}
#assignPi <- function()
#server.function.call <- call('assignPi')
#print(server.function.call)
#outcome <- ds.assign.value(new.variable.name = "aPieInTheSky", 
#                           value = server.function.call, 
#                           class.type = "numeric", 
#                           asynchronous = FALSE, 
#                           error.stop = TRUE, 
#                           datasources = connections)
#print(outcome)
```

```{r}
#lsDS<-function(search.filter=NULL,env.to.search)
#server.function.call <- call('lsDS', NULL,".GlobalEnv")
#print(server.function.call)
#outcome <- ds.aggregate(expression = server.function.call, asynchronous = #FALSE, error.stop = TRUE, datasources = connections)
#print(outcome)
```

```{r}
#rNormDS<-function (n, mean = 0, sd = 1, force.output.to.k.decimal.places=9)
#server.function.call <- call('rNormDS',1000)
#DSI::datashield.assign(conns = connections, symbol = "aNormDist1", value = server.function.call, async = FALSE)
```


```{r}
#rNormDS<-function (n, mean = 0, sd = 1, force.output.to.k.decimal.places=9)
#server.function.call <- call('rNormDS',1000)
#tryCatch(DSI::datashield.assign(conns = connections, symbol = "aNormDist1", value = server.function.call, async = FALSE),
#         error = function(error){print(DSI::datashield.errors())})
```




#logout
```{R}
outcome <- ds.logout(connections)
print(outcome)
```